# ユースケース定義

## 1. 主要ユースケース

### UC-001: システム常時起動とMIDIイベント監視
**アクター**: システム管理者
**目的**: システムを常時起動させ、MIDIイベントを継続的に監視する

**前提条件**:
- システムが起動している
- MIDIデバイスがシステムに接続されている

**基本フロー**:
1. システムが自動的に起動
2. システムが接続中のMIDIデバイス一覧を取得
3. システムが設定ファイルのpreferred_devicesリストを確認
4. システムがpreferred_devicesリストの最初のデバイスをデフォルト選択肢として設定
5. システムが選択されたデバイスでMIDIイベントの監視を開始
6. システムが受信したイベントをメモリに蓄積
7. システムが一定時間イベントなしを検出
8. システムが蓄積されたイベントをファイルに書き出し（yyyymmddhhmmss.mid形式）
9. システムがメモリをクリア
10. システムが次のイベント受信を待機

**代替フロー**:
- 2a. MIDIデバイスが接続されていない場合、ログに記録して待機
- 4a. preferred_devicesリストのデバイスが接続されていない場合、最初の接続デバイスを選択
- 8a. ファイル書き込み権限がない場合、エラーログに記録

**事後条件**:
- システムが常時起動し、選択されたMIDIデバイスからイベントを継続的に監視
- 一定時間イベントなし時に自動的にファイルに書き出し

### UC-002: 自動ファイル書き出し
**アクター**: システム
**目的**: 一定時間MIDIイベントが送信されなかった場合に、蓄積されたイベントを自動的にファイルに書き出す

**前提条件**:
- システムがMIDIイベントを監視中
- メモリにイベントが蓄積されている

**基本フロー**:
1. システムが最後のイベント受信時刻を記録
2. システムが設定された時間間隔でイベントなしをチェック
3. 一定時間イベントなしを検出
4. システムが蓄積されたイベントをMIDIファイルに書き出し（yyyymmddhhmmss.mid形式）
5. システムがメモリ上のイベントをクリア
6. システムが次のイベント受信を待機

**事後条件**:
- 蓄積されたイベントがMIDIファイルに保存される
- メモリがクリアされる

### UC-003: 記録データの確認
**アクター**: ユーザー
**目的**: 自動生成された記録ファイルの内容を確認する

**前提条件**:
- 記録ファイルが存在する

**基本フロー**:
1. ユーザーが記録ファイルを選択
2. システムがファイルを読み込み
3. システムがデータの概要を表示
4. ユーザーが詳細データを確認

**事後条件**:
- 記録データの内容が表示される

### UC-008: 手動録音停止・保存
**アクター**: ユーザー
**目的**: GUIボタンを押して現在の録音を手動で停止し、ファイルに保存する

**前提条件**:
- システムがMIDIイベントを監視中
- GUIが表示されている

**基本フロー**:
1. ユーザーがGUIの手動保存ボタンを押下
2. システムが現在の録音状態を確認
3a. バッファにイベントがある場合:
   - システムが蓄積されたイベントをファイルに書き出し
   - システムがメモリをクリア
3b. バッファが空の場合:
   - システムが最後に保存したMIDIファイルをコピー
   - システムが新しいファイル名で保存
4. システムが保存完了をユーザーに通知

**代替フロー**:
- 3a. ファイル書き込み権限がない場合、エラーメッセージを表示
- 3b. 最後に保存したファイルが見つからない場合、エラーメッセージを表示

**事後条件**:
- 現在の録音が停止される
- ファイルが手動保存先に保存される
- ユーザーに保存完了が通知される

## 2. 拡張ユースケース

### UC-004: 複数デバイスからの同時監視
**アクター**: システム
**目的**: 複数のMIDIデバイスからのイベントを同時に監視・記録する

**基本フロー**:
1. システムが接続中の複数のMIDIデバイスを検出
2. システムがpreferred_devicesリストの順序に基づいてデバイスを選択
3. システムが各デバイスからのイベントを並行監視
4. システムが各デバイスのイベントを個別に蓄積
5. システムが各デバイスで一定時間イベントなしを検出
6. システムが各デバイスのイベントを個別ファイルに書き出し（yyyymmddhhmmss.mid形式）

### UC-005: システム状態監視
**アクター**: システム管理者
**目的**: システムの動作状況を監視し、ログを確認する

**基本フロー**:
1. システムが動作状況をログに記録
2. システム管理者がログを確認
3. システム管理者が必要に応じて設定を調整

## 3. エラーケース

### EC-001: MIDIデバイス接続エラー
**状況**: MIDIデバイスが認識されない
**対応**: エラーログに記録し、デバイス再接続を待機

### EC-002: ファイル書き込みエラー
**状況**: ディスク容量不足や権限エラー
**対応**: エラーログに記録し、別の保存先を試行

### EC-003: メモリ不足エラー
**状況**: メモリ容量が不足
**対応**: 早期にファイル書き出しを実行し、メモリをクリア

### EC-004: 長時間動作によるメモリリーク
**状況**: 長時間動作によりメモリリークが発生
**対応**: 定期的なメモリ監視と自動クリア機能

### EC-005: 優先デバイスが見つからない
**状況**: preferred_devicesリストのデバイスが接続されていない
**対応**: 最初の接続デバイスを選択し、ログに記録

## 4. 非機能要件のユースケース

### UC-006: 長時間動作
**目的**: 24時間365日の安定動作を維持する
**要件**: メモリリークの防止、定期的なリソースクリア

### UC-007: 効率的なメモリ管理
**目的**: 最小限のメモリ使用量で動作する
**要件**: 効率的なデータ構造、適切なメモリクリア

### UC-009: ネットワークストレージへの保存（将来拡張予定）
**アクター**: システム
**目的**: ローカルストレージと並行してネットワークストレージにもファイルを保存する

**基本フロー**:
1. システムがファイル保存処理を実行
2. システムがローカルストレージに保存
3. システムがネットワークストレージに並行保存
4. システムが保存結果をログに記録

**要件**: ネットワークストレージの仕様が確定後に実装
